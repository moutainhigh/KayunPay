<!doctype html>
<html class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title></title>
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="icon" type="image/png" href="../assets/i/favicon.png">
<link rel="apple-touch-icon-precomposed"
	href="../assets/i/app-icon72x72@2x.png">
<meta name="apple-mobile-web-app-title" content="Amaze UI" />
<link rel="stylesheet" href="../assets/css/amazeui.min.css" />
<link rel="stylesheet" href="../assets/css/admin.css">
<link type="text/css" href="/portal/css/user.css?v=1.0.1" rel="stylesheet">
<style type="text/css">
  #biaoge{
     display:none;
     position: absolute;
     top: 50px;
     z-index: 999;
  }
</style>
</head>
<body onkeydown="zhazha(event)">
	<div class="am-g">
		<!-- 标准功能按钮 Start  -->
		<div class="am-u-sm-12 am-u-md-4">
			<div class="am-btn-toolbar">
			<!--  
				<div class="am-btn-group am-btn-group-xs">
					<button type="button" class="am-btn am-btn-default reback-btn" value="0">
						<span class="am-icon-trash-o"></span> 确认还款
					</button>
				</div>-->
				<!-- <div class="am-btn-group am-btn-group-xs">
					<button type="button" class="am-btn am-btn-default adv-reback-btn" value="1">
						<span class="am-icon-trash-o"></span> 人工提前还款
					</button>
				</div> -->
				<div class="am-btn-group am-btn-group-xs">
					<button type="button" class="am-btn am-btn-default tqhk-btn" value="1">
						<span class="am-icon-trash-o"></span> 设置自动提前还款
					</button>
				</div>
				<div class="am-btn-group am-btn-group-xs">
					<!-- <button type="button" class="am-btn am-btn-default yqhk-btn" value="I">
						<span class="am-icon-trash-o"></span> 设置逾期垫付利息
					</button> -->
					<button type="button" class="am-btn am-btn-default yqhk-btn" value="N">
						<span class="am-icon-trash-o"></span> 设置逾期不垫付利息
					</button>
				</div>
				<div class="am-btn-group am-btn-group-xs">
					<button type="button" class="am-btn am-btn-default drwj-btn" value="9">
						<span class="am-icon-trash-o"></span> 导入逾期文件
					</button>
				</div>
				<div class="am-btn-group am-btn-group-xs">
					 <a type="button" class="am-btn am-btn-default yqlist-btn" value="3" href="/pageLoanOverdueList">
					 查询逾期列表
					 </a>
				</div>
				<div class="am-btn-group am-btn-group-xs">
					<select data-am-selected="{btnSize: 'sm',btnWidth:'105%'}" name="zloanState" id="ZloanStateSel">
					</select>
				</div>
				
			</div>
		</div>
		<!-- 标准功能按钮  End -->
		<!-- 条件区 Start -->
		<div class="am-u-sm-12 am-u-md-4">
				<div class="am-u-sm-6" style="padding: 0;">
					<div class="am-input-group am-datepicker-date" data-am-datepicker="{format: 'yyyy-mm-dd', viewMode: 'days'}">
						<input type="text" class="am-form-field" id="my-startDate" placeholder="开始还款日期" readonly style="width: 71%;">
							<span class="am-input-group-btn am-datepicker-add-on">
								<button class="am-btn am-btn-default" type="button">
									<span class="am-icon-calendar"></span>
								</button>
					  		</span> 
					</div>
				</div>
				
				<div class="am-u-sm-6" style="padding: 0;">
					<div class="am-input-group am-datepicker-date" data-am-datepicker="{format: 'yyyy-mm-dd', viewMode: 'days'}">
						<input type="text" class="am-form-field" id="my-endDate" placeholder="结束还款日期" readonly style="width: 71%;">
							<span class="am-input-group-btn am-datepicker-add-on">
								<button class="am-btn am-btn-default" type="button">
									<span class="am-icon-calendar"></span>
								</button>
							</span>
					</div>
				</div>
		</div>
		<div class="am-u-sm-12 am-u-md-3">
			<div class="am-input-group am-input-group-sm">
				<input type="text" class="am-form-field allkey"><span
					class="am-input-group-btn">
					<button class="am-btn am-btn-default query-btn" type="button">搜索</button>
				</span>
			</div>
		</div>
	</div>

	<!-- 条件区  End -->
	<!-- Table -->
	<div class="am-g">
		<div class="am-u-sm-12">
			<table class="am-table am-table-bd am-table-striped admin-content-table">
				<thead>
				</thead>
				<tbody>
				</tbody>
			</table>
			<!-- 分页 -->
			<div class="am-cf pad-div">
				<span>共 15 条记录</span>
				<div class="am-fr">
					<ul class="am-pagination">
						<li class="am-disabled"><a href="#">首页</a></li>
						<li class="am-disabled"><a href="#">上一页</a></li>
						<li><a href="#">下一页</a></li>
						<li><a href="#">尾页</a></li>
						<li id="not"><input type="text" size="5" id="goValue" onkeypress="return IsNum(event)" value="1"/></li>
						<li id="go"><input type="button" value="GO" onclick="$('#go').attr('index',$('#goValue').val())"/></li>
					</ul>
				</div>
				<button class="am-btn am-btn-success am-btn-xs" onclick="exportExcel()" style="margin-left:10px" type="button">导出Excel</button>
			</div>
		</div>
	</div>
	<!-- iframe body end -->
	<div id="yinying" class="yinying" style="background-color: #f3f3f3;"></div>
	<div id="biaoge" style="position: fixed;top: 50px;z-index: 999;background-color: white;">
	   <form id='excel' action="/exportExcelyuqi" method="post" enctype="multipart/form-data">
               <input id="importFile" name="importFile" type="file"/>
               <select id = "selectType" name='overdueType'>
               <option value ="">逾期方式</option>
		       <option value ="A" >还本还息</option>
		       <option value ="P" >还本不还息</option>
		       <option value ="I" >不还本还息</option>
		       <option value ="N" >不还本不还息</option>
		    </select>
               <!-- <input id='fileSubmit' type="submit" value="确定"/> -->
	   </form>
	   <a href="javascript:void(0)"  style="width:100px;" onclick="fileUpload()">确定</a>
       <a href="javascript:void(0)"  style="width:100px;" onclick="closeUpload()">取消</a> 
        <!--  <div><button id="closebiaoge" type="button" value="关闭">关闭</button></div> -->
	</div>
	
	
	<!-- prompt start -->
	<div class="am-modal am-modal-prompt" tabindex="-1" id="promptDiv">
		<div class="am-modal-dialog">
			<div class="am-modal-hd title">标题</div>
			<div class="am-modal-bd content">
				 <span>提前还款日期(如2015年10月30日,格式：20151030)</span>
				 <input type="text" class="am-modal-prompt-input am-form-field">
			</div>
			<div class="am-modal-footer">
				<span class="am-modal-btn" data-am-modal-cancel>取消</span> <span
					class="am-modal-btn" data-am-modal-confirm>提交</span>
			</div>
		</div>
	</div>
	<!-- prompt end -->
	<!--[if lt IE 9]>
	<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
	<script src="../assets/js/polyfill/rem.min.js"></script>
	<script src="../assets/js/polyfill/respond.min.js"></script>
	<script src="../assets/js/amazeui.legacy.js"></script>
	<![endif]-->
	<!--[if (gte IE 9)|!(IE)]><!-->
	<script src="../assets/js/jquery.min.js"></script>
	<!--<![endif]-->
	<script src="../app/js/res.js"></script>
	<script src="../app/js/biz.js"></script>
	<script src="../app/js/table-widget.js"></script>
	<script src="../app/js/form-widget.js"></script>
	<script src="../app/js/isNum.js"></script>
	<script src="http://www.jfinal.com/assets/jquery_form/jquery.form.min.js"></script>
	<script>
	var exportExcelUrl = "/exportExcel?bb=caiwuzhuanyong1";
	
	$(".drwj-btn").click(function(){
		$("#biaoge").css("display","block");
		$("#yinying").show();
		$('body').css('overflow','hidden');
	})
	
	 $(document).on("click","#closebiaoge",function(){
    	$("#biaoge").css("display","none");
    	$("#yinying").hide();
    	$('body').css('overflow','auto');
    })
    
    function closeUpload(){
		$("#biaoge").css("display","none");
    	$("#yinying").hide();
    	$('body').css('overflow','auto');
	}
	
	function fileUpload(){
		var importFile = $("#importFile").val();
		var reg = ".xls$";
		var patrn = new RegExp(reg);
		if(patrn.exec(importFile)){
			
		}else{
			YRHX.alert1("提示", "请导入.xls文件");
			return;
		}
		if(window.confirm("确定导入此文件吗？"+"点击确定后不要重复点击，等待处理结果；点击取消，将不会处理文件")){
			YRHX.loading("open", "请耐心等待处理结果，时间有点漫长。。。");
			$("#excel").ajaxSubmit({
				url:"/exportExcelyuqi",
				type:"post",
				dataType: "json",
				success: function(sucData) {
					$("#biaoge").css("display","none");
			    	$("#yinying").hide();
			    	$('body').css('overflow','auto');
			    	var zSize = sucData.return_data.size;
			    	var sucSize = sucData.return_data.sucSize;
			    	var errSize = sucData.return_data.errSize;
			    	var dealLoanInfo = sucData.return_data.dealLoanInfo;
			    	YRHX.loading("close");
			    	if(sucData.return_code == "00"){
			    		YRHX.alert1("提示", "总共处理："+zSize+"条逾期数据"+";失败："+errSize+"条数据 "+";成功："+sucSize+"条数据;没处理 ："+dealLoanInfo || "处理成功");
			    	}else{
			    		YRHX.alert1("提示", sucData.return_info || "处理成功");
			    	}
			    	
			    
				}
				, error: function(sucData) {
					YRHX.loading("close");
					YRHX.alert1("提示", errData.return_info || "处理失败");
				}
				});
		}
		}
	
	function exportExcel(){
		var beginDate = $("#my-startDate").val();
		var endDate = $("#my-endDate").val();
		var para_url = "&beginDate="+beginDate.replaceAll("-","")+"&endDate="+endDate.replaceAll("-","")+"&loanState="+$("#ZloanStateSel").val();
		window.open(exportExcelUrl+para_url,"_blank");
	};
	function zhazha(e){
		var keynum = 0;
		if(window.event){
			keynum = e.keyCode
		}
		else if(e.which){
			keynum = e.which
		}
		if(keynum==13){
			queryData(1);
		}
	}
	
		$("#ZloanStateSel").makeSelect4s(YRHX.sortData(RES["DATA_MAP"]["map_hk_loanstate"]));
		$("#ZloanStateSel").val("N");
	
		var maxQueryNum = 10 ;
		var queryUrl = "/getLoanInfoList4Recy";
		var size=0;//总页数
				
		//查询实现
		function queryData( pNum , pSize ){
			//对页码参数验证
			if(isNaN(pNum)){
				alert("GO栏请输入数字！");
				return;
			}
			if(size<1){
				size=1;
			}
			if(pNum > size && size != 0){
				pNum=size;
				$("#goValue").val(pNum);
			}
			YRHX.ajax({
				url : queryUrl,
				data : {
					pageNumber : pNum,
					pageSize : pSize ||maxQueryNum ,
					allkey : $(".allkey").val(),
					beginDate : $("#my-startDate").val().replaceAll("-",""),
					endDate : $("#my-endDate").val().replaceAll("-",""),
					fuserCode : YRHX.queryString("fuserCode")||"",
					loanState : $("#ZloanStateSel").val()
				},
				success : function(sucData){
					size=Math.ceil(sucData["totalRow"]/maxQueryNum);//总页数
					/* var ct_info = "总计：&nbsp;";
					ct_info = ct_info + "借款金额共"+ YRHX.toDecimal2(sucData["count_loanAmount"]/ 10.0/10.0, "￥"); */
					var tmpTotalData = {};
					
					tmpTotalData["当前页 下期应还本息"] = YRHX.toDecimal2((sucData["nowAllbj"]+sucData["nowAlllx"])/ 10.0/10.0, "￥");
					tmpTotalData["当前页 下期应还本金"] = YRHX.toDecimal2(sucData["nowAllbj"]/ 10.0/10.0, "￥");
					tmpTotalData["当前页 下期应还利息"] = YRHX.toDecimal2(sucData["nowAlllx"]/ 10.0/10.0, "￥");
					
					//tmpTotalData["总计 借款金额"] = YRHX.toDecimal2(sucData["count_loanAmount"]/ 10.0/10.0, "￥");
					
					
					if(sucData["count_nextInterest"] && sucData["count_nextAmount"]){
						tmpTotalData["总计 下期应还本息"] = YRHX.toDecimal2((sucData["count_nextAmount"] +sucData["count_nextInterest"])/ 10.0/10.0, "￥");
					}
					if(sucData["count_nextAmount"]){
						tmpTotalData["总计 下期应还本金"] = YRHX.toDecimal2(sucData["count_nextAmount"]/ 10.0/10.0, "￥");
					}
					if(sucData["count_nextInterest"]){
						tmpTotalData["总计 下期应还利息"] = YRHX.toDecimal2(sucData["count_nextInterest"]/ 10.0/10.0, "￥");
					}
					
					if(sucData["count_leftAmount"] && sucData["count_leftInterest"]){
						tmpTotalData["总计 待还本息"] = YRHX.toDecimal2((sucData["count_leftAmount"]+sucData["count_leftInterest"])/ 10.0/10.0, "￥");
					}
					
					if(sucData["count_leftAmount"]){
						tmpTotalData["总计 待还本金"] = YRHX.toDecimal2(sucData["count_leftAmount"]/ 10.0/10.0, "￥");
					}
					if(sucData["count_leftInterest"]){
						tmpTotalData["总计 待还利息"] = YRHX.toDecimal2(sucData["count_leftInterest"]/ 10.0/10.0, "￥");
					}
					if(sucData["count_settleInterest"]){
						tmpTotalData["提前结清 待还利息"] = YRHX.toDecimal2(sucData["count_settleInterest"]/ 10.0/10.0, "￥");
					}
					
					makeTable(sucData.list , {
						index : sucData["pageNumber"] ,
						max : sucData["pageSize"] ,
						size : sucData["totalRow"]
					},tmpTotalData);
				},
				error : function(data) {
					YRHX.alert("警告",data.return_info || "获取信息失败");
				}
			});
			
		}
		
		$(".query-btn").click(function(){
			queryData(1);
			$("#goValue").val(1);//设置GO栏默认页码为1
		});
		
		$("div.pad-div").initPagEvent( queryData );
		
		//init 
		var loanStateData = YRHX.sortData(RES["DATA_MAP"]["loanState"]) ;
		$("#loanStateSel").makeSelect4s(loanStateData);
		
		var productTypeData = YRHX.sortData(RES["DATA_MAP"]["productType"]) ;
		var estatusData = YRHX.sortData(RES["DATA_MAP"]["estatus"]) ;
		
		function makeTable( tableData ,pageData,countData){
			$(".am-g").table({
						count_info : countData,
						thtdcls : "font-size:12px;padding:4px 1px",
						dataFormat : function(rowObj) {
							rowObj["loanAmount"] = YRHX.toDecimal2(rowObj["loanAmount"]/10.0/10.0 , "￥");
							rowObj["loanStateDesc"] = loanStateData[rowObj["loanState"] ];
							if(rowObj["loanTitle"].length>20){
								rowObj["loanTitle"] = rowObj["loanTitle"].substring(0,20)+"...";
							}
							if( "00000000" == rowObj["backDate"] ){
								rowObj["backDate"] = " ";
							}else{
								rowObj["backDate"] = rowObj["backDate"].dateformat();
							}
							rowObj["reciedCount"] = " "+rowObj["reciedCount"] ;
							
							rowObj["loanArea"] = rowObj["loanArea"] ? rowObj["loanArea"] : " ";
							
							rowObj["yinghuanbx"] = YRHX.toDecimal2(rowObj["yinghuanbx"]/10.0/10.0 , "￥");
							rowObj["yihuanbx"] = YRHX.toDecimal2(rowObj["yihuanbx"]/10.0/10.0 , "￥");
							rowObj["yihuanbj"] = YRHX.toDecimal2(rowObj["yihuanbj"]/10.0/10.0 , "￥");
							rowObj["yihuanlx"] = YRHX.toDecimal2(rowObj["yihuanlx"]/10.0/10.0 , "￥");
							rowObj["daihuanbx"] = YRHX.toDecimal2(rowObj["daihuanbx"]/10.0/10.0 , "￥");
							rowObj["daihuanbj"] = YRHX.toDecimal2(rowObj["daihuanbj"]/10.0/10.0, "￥");
							rowObj["daihuanlx"] = YRHX.toDecimal2(rowObj["daihuanlx"]/10.0/10.0 , "￥");
							rowObj["xqbj"] = YRHX.toDecimal2(rowObj["xqbj"]/10.0/10.0 , "￥");
							rowObj["xqlx"] = YRHX.toDecimal2(rowObj["xqlx"]/10.0/10.0 , "￥");
							rowObj["productType"] = productTypeData[rowObj["productType"] ];
							if(rowObj["estatus"] && rowObj["estatus"]!='nil')
								rowObj["estatus"] = estatusData[rowObj["estatus"]];
							else
								rowObj["estatus"] = "未设置";
							if(rowObj["earlyDate"] && rowObj["earlyDate"] !='nil')
								rowObj["earlyDate"] = rowObj["earlyDate"].dateformat();
							else
								rowObj["earlyDate"] = "未设置"
							return rowObj;
						},
						max : 10,
						pag : pageData,
						header : [
								{
									name : "",type : "checkbox",key : "loanCode"
								},
								{
									name : "",text : "借款序号",html : "#{loanNo}"
								},
								{
									name : "",text : "标题",html : "#{loanTitle}"
								},
								{
									name : "",text : "借款金额",html : " #{loanAmount}"
								},
								{
									name : "",text : "还款期数",html : " #{reciedCount}/#{loanTimeLimit}期"
								},
								{
									name : "",text : "应还本息(总计)",html : "#{yinghuanbx}"
								},
								{
									name : "",text : "已还本息(总计)",html : "#{yihuanbx}"
								},
								{
									name : "",text : "已还本金(总计)",html : "#{yihuanbj}"
								},
								{
									name : "",text : "已还利息(总计)",html : "#{yihuanlx}"
								},
								{
									name : "",text : "待还本金(总计)",html : "#{daihuanbj}"
								},
								{
									name : "",text : "待还本息(总计)",html : "#{daihuanbx}"
								},
								{
									name : "",text : "下期待还本金",html : "#{xqbj}"
								},
								{
									name : "",text : "下期待还利息",html : "#{xqlx}"
								},
								{
									name : "",text : "还款日",html : "#{clearDay}"
								},
								{
									name : "",text : "状态",html : "#{loanStateDesc}"
								},
								{
									name : "",text : "下期还款日",html : "#{backDate}"
								},
								{
									name : "",text : "借款人姓名",html : "#{userName}"
								},
								{
									name : "",text : "来源",html : "#{loanArea}"
								},
								{
									name : "",text : "提前还款状态",html : "#{estatus}"
								},
								{
									name : "",text : "提前还款日期",html : "#{earlyDate}"
								},
								{
									name : "",text : "是否逾期",html : "#{isOverdue}"
								},
								{
									name : "",text : "操作",html : $.makeButtons([{"text":"查看详情","url":"pageLoanForm?opType=view&loanCode=#{loanCode}","ico":"am-icon-pencil-square-o"},
																				{"text":"投标流水","url":"pageLoanTraceList?loanCode=#{loanCode}","ico":"am-icon-pencil-square-o"}])
								}],
						data : tableData
					});
			}
	</script>
	<script src="../assets/js/amazeui.min.js"></script>
	<script>
		queryData(1);
		/**
		$(".reback-btn").click(function(){
			var row = window.getCheckedRow() ;
			if( row.length == 0){
				YRHX.alert("提示","请勾选需要还款的标！");
				return ;
			}
			if( row.length == 1){
				if( confirm("确定执行操作？") ){
					YRHX.ajax({
						url : "/recy4loan",
						data : {
							loanCode : row.attr("key") 
						},
						success : function(sucData){
							YRHX.alert("提示","成功还款！");
						},
						error : function(data) {
							if(data.return_code=="-315"){
								var error_Msg = "";
								$.each(data.return_data,function(key,value){
									error_Msg = error_Msg + value+"<br>";
								});
								YRHX.alert("警告",error_Msg);
							}else{
								YRHX.alert("警告",data.return_info || "获取信息失败");
							}
						}
					});
				}
				
			}else{
				YRHX.alert("慎选","一次最多只可选择一个标！");
				return ;
			}
		});*/
		
		$(".tqhk-btn").click(function(){
			var row = window.getCheckedRow();
			if (row.length == 0) {
				YRHX.alert("提示", "未选中需要提前还款的标！");
				return;
			}
			if (row.length == 1) {
				YRHX.prompt("提前还款","提前还款日期(如2015年10月30日,格式：20151030)",function(e){
					var earlyDate = e.data;
					row = window.getCheckedRow();
					YRHX.ajax({
						url : "/addSettlementEarlySettings" ,
						data :{
							"earlyDate" : earlyDate ,
							"loanCode" : row.attr("key")
						},
						success:function(data){
							if(data==true)
								YRHX.alert("操作完成","设定提前还款日期完成");
							else
								YRHX.alert("操作未生效","操作未生效");
						},
						error : function(data){
							if(data.return_code=="-315"){
								var error_Msg = "";
								$.each(data.return_data,function(key,value){
									error_Msg = error_Msg + value+"<br>";
								});
								YRHX.alert("警告",error_Msg);
							}else{
								YRHX.alert("警告",data.return_info || "获取信息失败");
							}
						}
					});
					
				});
			} else {
				YRHX.alert("提示", "一次最多只可以选择一个！");
				return;
			}
		});
		
		$(".yqhk-btn").click(function(){
			var confirmOp = confirm("确定设置逾期?");
			if(confirmOp){
			var row = window.getCheckedRow();
			if (row.length == 0) {
				YRHX.alert("提示", "未选中需要逾期的标！");
				return;
			}
			if (row.length == 1) {
					row = window.getCheckedRow();
					YRHX.ajax({
						url : "/setOverdue" ,
						data :{
							"loanCode" : row.attr("key"),
							"overdueType" : $(this).val()
						},
						success:function(data){
							YRHX.alert("操作完成","设定逾期完成");
						},
						error : function(data){
							if(data.return_code=="-315"){
								var error_Msg = "";
								$.each(data.return_data,function(key,value){
									error_Msg = error_Msg + value+"<br>";
								});
								YRHX.alert("警告",error_Msg);
							}else{
								YRHX.alert("警告",data.return_info || "获取信息失败");
							}
						}
					});
					
			} else {
				YRHX.alert("提示", "一次最多只可以选择一个！");
				return;
			}
			}
		});
		
		$(".adv-reback-btn").click(function(){
			var row = window.getCheckedRow() ;
			if( row.length == 0){
				YRHX.alert("提示","请勾选需要提前还款的标！");
				return ;
			}
			if( row.length == 1){
				if( confirm("确定执行操作？") ){
					YRHX.ajax({
						url : "/advRecy4loan",
						data : {
							loanCode : row.attr("key") 
						},
						success : function(sucData){
							YRHX.alert("提示","提前成功还款！");
						},
						error : function(data) {
							if(data.return_code=="-315"){
								var error_Msg = "";
								$.each(data.return_data,function(key,value){
									error_Msg = error_Msg + value+"<br>";
								});
								YRHX.alert("警告",error_Msg);
							}else{
								YRHX.alert("警告",data.return_info || "获取信息失败");
							}
						}
					});
				}
				
			}else{
				YRHX.alert("慎选","一次最多只能选择一个标！");
				return ;
			}
		});
		
		setTimeout(function () {
	        $("#ZloanStateSel").change(function () {
	            queryData(1);
	        });
	    }, 2000);
		
		function showPrompt(title , content , callback ){
			$('#promptDiv').find("div.title").text(title);
			$('#promptDiv').find("div.content").find("span").text(content);
			$('#promptDiv').find("input").val("");
			$('#promptDiv').modal({
				relatedTarget: this,
				onConfirm: callback ,
				onCancel: function(e) {
				}
			});
		}
	</script>
</body>
</html>
